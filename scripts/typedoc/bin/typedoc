#!/bin/bash
set -o errexit -o nounset -o pipefail
command -v shellcheck > /dev/null && shellcheck "$0"

# A typedoc executable installed on demand in a temp dir
#
# Note: typedoc is hard to encapsulate in a docker container because from there it
# cannot easily access configuration, input and output files of the host system.

TYPEDOC_VERSION="v0.15.0-0"

TMP_DIR="${TMPDIR:-/tmp}/@iov"
mkdir -p "$TMP_DIR"

EXECUTABLE="$TMP_DIR/typedoc/bin/typedoc"

if [ ! -f "$EXECUTABLE" ]; then
  (
    cd "$TMP_DIR"
    git clone --depth 100 --branch master https://github.com/TypeStrong/typedoc.git
    git -C ./typedoc checkout "$TYPEDOC_VERSION"
    (cd ./typedoc && npm install && npm run prepare)
  )
fi

"$EXECUTABLE" "$@"
