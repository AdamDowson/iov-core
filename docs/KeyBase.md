# Keybase Architecture

Web4 needs to support a variety of chains, each with their own specifications for how addresses (accounts) are derived.

## Key Terms:

- UserProfile: A collection of User materials. Includes multiple `keyringEntries` associated with a UserProfile.
- Keyring: An object containing `keyringEntries`.
- keyringEntries: An array owned by the `keyring`, which houses individual `KeyringEntry`s
- keyringEntry: An object which houses ONE `SecretIdentity` and N `PublicIdentities`.
- SecretIdentity: Single Private material entry in a `KeyringEntry`, used for signing transactions and deriving `PublicIdentities`.
- PublicIdentities: Public materials collection. Contains the an array of objects related to `SecretIdentity`.
- PublicIdentity: Derived Addresses, PublicKeys, and curve data that is chain specific. Always defined via the HD specifications. Used for end user queries for balances and transaction histories.

## Feature Set:

### Generation and Import/Export of HD Seeds

The Web4 Keybase will require the ability to generate new seeds from entropy for a user, when needed. This can occur when a UserProfile is made, or later on demand by the User.

### Creation of Public Keys, and Addresses

The Seeds generated by the Keybase will be used to create new public keys, and addresses for use with blockchain technology.

### Support for secp256k1 and ed25519

These are the two "industry standard" cryptographic algorithms. Both need to be supported to enable the greatest compatibility. Others can be supported later, such as `zk-snarks`.

### Hardware wallets, Ledger (Others TBA)

Hardware wallet support is necessary as more users are using these devices. Ledger will be the first device type supported by the Keybase.
### Transaction/Message operations

The Keybase will have the following features:
- Sign Transactions
- Encrypt and Decrypt Messages
- Sign and Verify Messages


## Standards Used:

### Hierarchical Deterministic Wallets
HD wallets will be created through this standard to yield a master publickey:privatekey pair.

- BIP32: https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki

### Multi-Account Hierarchy for Deterministic Wallets
HD Wallets for chain specific support will be created through the following standards for each algorithm.

#### secp256k1
- BIP43: https://github.com/bitcoin/bips/blob/master/bip-0043.mediawiki
- BIP44: https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki

#### ed25519
- SLIP0010: https://github.com/satoshilabs/slips/blob/master/slip-0010.md

#### Both
- SLIP0044: https://github.com/satoshilabs/slips/blob/master/slip-0044.md

### HD Seed Generation:
Seed generation will be performed through the BIP39 specification for HD seeds

- BIP39: https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki


# Code Architecture
The code for keyring management is broken down into logical units, each performing a specific task. The design can be visualized as follows:

```
UserProfileController (1 UserProfileController)
  |
  | > UserProfile (1 UserProfile : N Users)
      |
      | > AddressBook (1 AddressBook : 1 UserProfile)
      |   | > AddressBookEntries (1 AddressBook : N AddressBookEntries)
      |
      | > SecurityModel (1 SecurityModel : 1 UserProfile)
      |
      | > Keyring (1 Keyring : 1 UserProfile)
          |
          | > keyringEntries (1 Keyring : N KeyringEntries)
              |
              | > SecretIdentity (1 KeyringEntry : 1 SecretIdentity)
                  |
                  | > PublicIdentities (1 SecretIdentity : N PublicIdentities)
```


## UserProfileController

The `UserProfileController` houses the logic to decrypt a user profile, when provided a valid `username:password` pair.

The following functions are called by the `User`, through the `UserProfileController`

### Functions:

- CreateUser: Creates a new user in the `UserProfileController`
- LoginUser: Passes `username:password` pair to the `UserProfileController`
- DeleteUser: Requests deletion of a `UserProfile` to the `UserProfileController`
- ExportUser: Requests the plaintext export of `UserProfile` details, requires a correct `login`

### Object Definition:

```
{
  "UserProfiles": []
}
```

## UserProfile

 A `UserProfile` contains an array called `keyringEntries`, an object called
`addressBook`, and an object called `securityModel`. This is a `1:N` relation,
where `N` is each `UserProfile` created by the `UserProfileController`.

### Object Definition:
```
"UserProfile": {
  "username": "isabella",
  "label": "My Profile",
  "created": "2018-06-18T14:52:26+00:00" #  ISO 8601 compatible
  "securityModel": {
    "password": "010000000105287a343ffb315b1...",
    "timeout": 3600,
    "retries": 100
  },
  "keyring": {
    "keyringEntries": [],
  },
  "addressBook": {
    "addressBookEntries": []
  }
}
```

## addressBook

Contains a list of addresses a user has interacted with, or added for frequent use.

### Functions:
- AddContact: Adds a contact to a `AddressBook` with the specified information. EX: `chain:address:humanName`
- DeleteContact: Deletes a contact from a `AddressBook`
- GetContact: Returns the `chain:address:humanName` for use in the application.

### Object Definition:
```
"addressBook": {
  "addressBookEntries": [
    {
      "address": "0x52b96095d265a93308fcf5cb9627085f029546be8b3",
      "chain": "ETH", # Up for debate, can be coin_type instead
      "created": "2018-06-18T14:52:26+00:00" #  ISO 8601 compatible,
      "label": "Friend's Account"
    }
  ]
}
```

## Keyring

The `Keyring` is an object that houses `keyringEntries`. This Object holds all
of the `UserProfile`'s `KeyringEntries`. This is a `1:1` relation inside of a
`UserProfile`.

### Functions:
- GetKeyringEntry: Returns a requested `KeyringEntry`'s details, such as `PublicIdentities`.
- AddKeyringEntry: Adds a new `KeyringEntry`, with a specified `SecretIdentity` to the `Keyring`.
- DeleteKeyringEntry: Removes an existing `KeyringEntry` from the `KeyringEntries` array.
- ExportKeyringEntry: Exports a `KeyringEntry` in plain text

### Object Definition:
```
"keyring": {
  "keyringEntries": []
},
```

## KeyringEntry

A `KeyringEntry` contains all of the related `SecretIdentity`,
`PublicIdentities` and personality information for an associated `SecretIdentity`.

A `SecretIdentity` is only an HD Seed value (`Mnemonic Passphrase`) or a
hardware device identifier for a `Ledger`.

This is a `1:1` relation, where each `KeyringEntry` has one `SecretIdentity`.

### Functions:
- CreateSecretIdentity: Creates a `SecretIdentity`, if the `KeyRingEntry` has none.
- RenameSecretIdentity: Changes the label of the `keyringEntry`.
- DeleteSecretIdentity: Removes the `SecretIdentity` from the `keyringEntry`.
- ExportSecretIdentity: Exports the `SecretIdentity` in plain text.

### Object Definition:
```
"KeyringEntry": {
  "label": "My Account",
  "SecretIdentity": {
   "seed": "shift nature mean excess demise mule winter between swing success bitter patch",
   "type": "HD" || "hardware"
  },
  "PublicIdentities": [
    "PublicIdentity": {}
  ]
}
```

## PublicIdentities

A `PublicIdentities` are derived from `seed:curve` pairs, which are used to
create a `PublicIdentity`.

This is a `1:N` relation, where 1 is the `SecretIdentity` for which the
`PublicIdentity` is related and N are the generated `PublicIdentities`.  

### Functions:
- GetPublicIdentity: Returns `PublicIdentity` details for a specific algorithm.
- CreatePublicIdentity: Creates a `PublicIdentity` from the `SecretIdentity`.
- DeletePublicIdentity: Removes a `PublicIdentity` from `PublicIdentities`.
- ExportPublicIdentity: Exports  a `PublicIdentity` in plain text.

### Object Definition:
```
"PublicIdentities": [
  "PublicIdentity": {
    "address": "0x6806ea1d9b2eb59DAc7fdcdf28bf8d5a12AD84Bc",
    "label": "Wells Fargo",
    "publicKey": {
      "algo": ed25519,
      "data": "52b96095d265a93308fcf5cb9627085f029546be8b31eccb00bad386a92544d7"
    },
    "curve": {
      "root": "m",
      "purpose": "44'",
      "coin_type": "60'", # Defined here: https://github.com/satoshilabs/slips/blob/master/slip-0044.md
      "account": "0'",
      "change": "0'",
      "address_index": "0"
    }
  }
]
```

## Complete Object Definition
```
"UserProfile": {
  "username": "isabella",
  "label": "My Profile"
  "email": "isabella@iov.one",
  "created": "2018-06-18T14:52:26+00:00" #  ISO 8601 compatible
  "securityModel": {
    "password": "010000000105287a343ffb315b1...",
    "timeout": 3600,
    "retries": 100
  },
  "keyring": {
    "keyringEntries": [
      "KeyringEntry": {
        "SecretIdentity": {
         "label": "My Account",
         "seed": "shift nature mean excess demise mule winter between swing success bitter patch",
         "type": "HD" || "hardware"
        },
        "PublicIdentities": [
          "PublicIdentity": {
            "address": "0x6806ea1d9b2eb59DAc7fdcdf28bf8d5a12AD84Bc",
            "label": "Wells Fargo",
            "publicKey": {
              "algo": ed25519,
              "data": "52b96095d265a93308fcf5cb9627085f029546be8b31eccb00bad386a92544d7"
            },
            "curve": {
              "root": "m",
              "purpose": "44'",
              "coin_type": "60'", # Defined here: https://github.com/satoshilabs/slips/blob/master/slip-0044.md
              "account": "0'",
              "change": "0'",
              "address_index": "0"
            }
          }
        ]
      }
    ],
  },
  "addressBook": {
    "addressBookEntries": [
      {
        "address": "0x52b96095d265a93308fcf5cb9627085f029546be8b3",
        "chain": "ETH", # Up for debate, can be coin_type instead
        "created": "2018-06-18T14:52:26+00:00" #  ISO 8601 compatible,
        "label": "Friend's Account"
      }
    ]
  }
}
```

# Address Architecture


## Extended Addresses:

In many circumstances, users will want a chain specific key that can be portable if needed. We can provide them access to these keys using the full BIP43/44 specifications.

> m / purpose' / coin_type' / account' / change / address_index

Purpose MUST follow the BIP44 specification and as such, be set to be `44'`. `coin_type` MUST be supported according to the SLIP list. This will provide the greatest compatibility, especially if a user needs to exit the system.

Users MAY use these individual chain specific addresses.

This is support is also critical for users who are importing HD seeds from other software, so that we can locate existing tokens for that user. During the import process, that user should be given a choice of supported tokens to add to the list and the software can automatically derive the addresses that are already used. In the case of many addresses, the user can use a `load more` button.

### Keyring Mappings

Each UserProfile will MAY contain Multiple `keyringEntries` under its `Keyring`. Each `keyringEntry` will contain an HD Seed, or HW wallet identifier and some information that has been exported from that device (pubkey, address). These entries will be referred to as `KeyringEntries`.

The `KeyringEntries` will be differentiated in the profile with a Label. This label will be user specifiable, but by default indicate the type.

- HD Seed (When decrypted): `Magic Word #` :unlock:
- HD Seed (When Encrypted): `Magic Word #` :lock:
- HW Device: `Ledger #` || `Trezor #` || `Other HW Device #`

Users can import a preexisting `seed` into the system, but Users will NOT be able to import raw private keys into the system. This is necessary to reduce code complexity and user integration. Users who wish to migrate into our system should be provided documentation on the process to generate a new HD Seed, and what is required to move their tokens into that wallet.

# Security Concerns

## Different Private Key Per Curve

We can reuse the same seed for each `Curve`, and derive different publickey/private key pairs using the instructions found in SLIP-0010. This mitigates security concerns around private key reuse. This method is how Trezor and Ledger derive keys for different curves.

# User Stories

## User Profiles

### I want to Add a Profile

Create a profile with `username`, `label`, and a `password` calling `UserProfileController.CreateUser`.

This has an empty `addressBook` and `keyring`. The `securityModel` is initialized from the system defaults.

### I have Profile and want to Login.

Request login using supplied `username` and `password` by calling `UserProfileController.LoginUser`. This password needs to match against the hash in the `UserProfile.securityModel.password`.

### I want to delete my User Profile.

Request profile deletion using supplied `username` and `password` by calling  `UserProfileController.DeleteUser`. This password needs to match against the hash in the `UserProfile.securityModel.password`.

### I want to export my profile

Request profile export using supplied `username` and `password` by calling `UserProfileController.DeleteUser`. This password needs to match against the hash in the `UserProfile.securityModel.password`.

## SecretIdentity

### I don't have a `SecretIdentity` and want to Add one

Create a new a `keyringEntry` populated with a `SecretIdentity`. This `keyringEntry` is added to the `keyringEntries` array.

## I have a `SecretIdentity` and I want to create an address

Add a `publicIdentity` to `publicIdentities` using the `SecretIdentity`.
